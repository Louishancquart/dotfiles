# Install Mail-Server

## Prerequisite

Requires valid certificates generated by Let's Encrypt

## Description

### Postfix

We'll use **Postfix** as an SMTP service secured with TLS.

> **Postfix** is a free and open-source mail transfer agent (MTA) that routes and delivers electronic mail.
>
> -- <cite>Wikipedia</cite>

#### References

[Postfix Documentation]  
[Postfix Wikipedia]

### Dovecot

We'll use **Dovecot** an IMAP service secured with TLS.

> **Dovecot** is an open-source IMAP and POP3 server for Unix-like operating systems, written primarily with security in mind.
>
> -- <cite>Wikipedia</cite>

#### References

[Dovecot Documentation]  
[Dovecot Wikipedia]

### SpamAssassin

We'll use **Spam Assassin** as a plugin to Postfix to filter entering e-mails.

> **Apache SpamAssassin** is a computer program used for e-mail spam filtering. It uses a variety of spam-detection techniques, including DNS and fuzzy checksum techniques, Bayesian filtering, external programs, blacklists and online databases.
>
> -- <cite>Wikipedia</cite>

#### References

[SpamAssassin Documentation]  
[SpamAssassin Wikipedia]

### OpenDKIM

We'll use **OpenDKIM** to sign and certify our e-mails et check entering e-mails.

> **DomainKeys Identified Mail (DKIM)** is an email authentication method designed to detect forged sender addresses in emails (email spoofing), a technique often used in phishing and email spam.
>
> -- <cite>Wikipedia</cite>

#### References

[OpenDKIM Documentation]  
[DKIM Wikipedia]

### OpenDMARC

We'll use **OpenDMARC** to inform other e-mail servers/platforms what to do when they receive e-mails from our domain.

> **DMARC (Domain-based Message Authentication, Reporting and Conformance)** is an email authentication protocol. It is designed to give email domain owners the ability to protect their domain from unauthorized use, commonly known as email spoofing. The purpose and primary outcome of implementing DMARC is to protect a domain from being used in business email compromise attacks, phishing emails, email scams and other cyber threat activities.
>
> -- <cite>Wikipedia</cite>

#### References

[OpenDMARC Documentation]  
[DMARC Wikipedia]

### ClamAV

We'll use **ClamAV** to scan in/out e-mails and attachements for viruses or malwares.

> **Clam AntiVirus (ClamAV)** is a free software, cross-platform and open-source antivirus software toolkit able to detect many types of malicious software, including viruses. One of its main uses is on mail servers as a server-side email virus scanner.
>
> -- <cite>Wikipedia</cite>

#### References

[ClamAV Documentation]  
[ClamAV Wikipedia]

### Sieve

We'll use **Sieve** to apply filters on our e-mails to organize our INBOX.

> **Sieve** is a programming language that can be used for email filtering.
>
> -- <cite>Wikipedia</cite>

#### References

[Sieve Documentation]  
[Sieve Wikipedia]

## Installation

### Postfix

```bash
sudo apt-get install postfix
```

Choose "OK" > "Internet Site">  FQDN of your server (like "www.mydomain.com") .

*Don't forget to backup your original files first*
Copy the configuration files `config/etc/postfix/main.cf` and `config/etc/postfix/master.cf` in your `/etc/postfix` folder.  


Replace in the config files the `[[DOMAIN]]` keywords with your domain name.

Use the postalias command to create Postfix db for `/etc/aliases`

```bash
postalias /etc/aliases
```

*This file will clean headers in your e-mails :*
Copy the file `config/etc/postfix/header_checks` in `/etc/postfix` and use the postmap command on it.  


```bash
postmap /etc/postfix/header_checks
```

If you don't want to use any aliases for your users, juste comment the lines referring to the files `/etc/postfix/smtpd_sender_login_maps` and `/etc/postfix/virtual` in your `/etc/postfix/main.cf` configuration file.

Enable the service

```bash
systemctl enable postfix.service
```


#### Optional

If you want to use alias for some users, you can use the `config/etc/postfix/smtpd_sender_login_maps` and `config/etc/postfix/virtual` files.  
Just copy them to your `/etc/postfix` folder and use postmap command on them.

```bash
postmap /etc/postfix/smtpd_sender_login_maps
postmap /etc/postfix/virtual
```

### Dovecot

```bash
sudo apt-get install dovecot-core dovecot-imapd
```

You can copy all the files in `config/etc/dovecot` in your `/etc/dovecot` folder.  
*Don't forget to backup your original files first*

Edit your `/etc/dovecot/conf.d/10-ssl.conf` and replace all the `[[DOMAIN]]` keywords with you domain name.

Enable the service

```bash
systemctl enable dovecot.service
```

### SpamAssassin

```bash
sudo apt-get install spamassassin spamc
```
*Don't forget to backup your original files first*
Copy the `config/etc/spamassassin/local.cf` in your `/etc/spamassassin` folder.  


Edit your `/etc/spamassassin/local.conf` and replace all the `[[DOMAIN]]` keywords with you domain name. You can also customize the subject rewriting if you want to.

Copy the `config/default/spamassassin` and replace your `/default/spamassassin` file.  
*Don't forget to backup your original file first*

Enable the service

```bash
systemctl enable spamassassin.service
```

### OpenDKIM

```bash
sudo apt-get install opendkim opendkim-tools
```

Use the configuration file `config/etc/opendkim.conf` (backup your `/etc/opendkim.conf` before)

Create the folders for Postfix and add the `opendkim` groups to the `postfix` user.

```bash
mkdir /var/spool/postfix/opendkim
chown opendkim: /var/spool/postfix/opendkim
usermod -aG opendkim postfix
```

Create the keys directory

```bash
mkdir -p /etc/opendkim/keys
```

Copy all the configuration files in `config/etc/opendkim` in `/etc/opendkim` and replace `[[DOMAIN]]` with your domain name within those files.

Create a directory named with your domain in `/etc/opendkim/keys` as `/etc/opendkim/keys/[[DOMAIN]]`

Go to your folder and generate your key

```bash
cd /etc/opendkim/keys/[[DOMAIN]]
opendkim-genkey -s mail -d [[DOMAIN]] -b 4096
```

***If your regisar doesn't accept keys over 2048, replace 4096 with 2048***

Update your key permissions

```bash
chown opendkim:opendkim mail.private
```

Copy the content of mail.txt to your DNS zone. Your file should have a similar content

```vim
# cat mail.txt

mail._domainkey	IN	TXT	( "v=DKIM1; k=rsa; "
	  "p=MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA5tSGc+j5pLEuWeR4NIhDRPhwHUZll1/N3ajHF1wSttUVp/igdcpZTKTD7ccFmsY0l+72Q+rlnoCGGdhdw0ImRoPVZwBfSxvC3alw/YLLCEwpy+J/tXx2WOPdHM95TVbt0S/wVWpPxmr3mAIPO24R4NEf0yQdvktnB26UTcLBEMtqAEtEDLqrea/XM5HQMngWXAARy379H6mo1Y"
	  "ee3wUqYZPX+g8ljZZMpIlvaE0pjtVIZ0kV8/kXz0fa1XHanc6rTsF7/XxCLYJRAK6fcfO8u/Ro65uWNM3x8+WN1nkf/ojh8VN/0A5oUrlQVWba4OEXxCkbZTU7V+4okyyhAHV2+/c0qRsKRNj2YuPl3DmJ8/me/UBHbIEeji7kcBuVkgv0cakHolMbKWESBuuw1F5MPThQ3qbUcCI9mY4OtTnElk40DVXMenKwQ1EnqJZlHtj6XOo0/na4"
	  "epqH+rtUOXhan6ewd8XQvJk630Qi1FHzWmO7i4pb8Uo0EDrAQmPvCNsR+AttrIdK7Ry3xgKAUdSyfT2GXmtP3hpr4l2w0Qv0sXAkVzz9xF0OsUjb3pztdAKz9t9pHiIj3C5p0HQZTAr7oVAzjiDu6gntfoMzTB6mY6PKF2TYOBagu0AZAwgwuWb24zrGPXRPS8U01TlY6UVzFJbB+97i0Nim5jQmyf/r38cCAwEAAQ==" )  ; ----- DKIM key mail for [[DOMAIN]]
```

Don't forget to delete all the spaces between the quoted strings **OR** delete all spaces and the quotes to have a unique string.

```vim
mail._domainkey	IN	TXT	( "v=DKIM1; k=rsa; ""p=MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA5tSGc+j5pLEuWeR4NIhDRPhwHUZll1/N3ajHF1wSttUVp/igdcpZTKTD7ccFmsY0l+72Q+rlnoCGGdhdw0ImRoPVZwBfSxvC3alw/YLLCEwpy+J/tXx2WOPdHM95TVbt0S/wVWpPxmr3mAIPO24R4NEf0yQdvktnB26UTcLBEMtqAEtEDLqrea/XM5HQMngWXAARy379H6mo1Y""ee3wUqYZPX+g8ljZZMpIlvaE0pjtVIZ0kV8/kXz0fa1XHanc6rTsF7/XxCLYJRAK6fcfO8u/Ro65uWNM3x8+WN1nkf/ojh8VN/0A5oUrlQVWba4OEXxCkbZTU7V+4okyyhAHV2+/c0qRsKRNj2YuPl3DmJ8/me/UBHbIEeji7kcBuVkgv0cakHolMbKWESBuuw1F5MPThQ3qbUcCI9mY4OtTnElk40DVXMenKwQ1EnqJZlHtj6XOo0/na4""epqH+rtUOXhan6ewd8XQvJk630Qi1FHzWmO7i4pb8Uo0EDrAQmPvCNsR+AttrIdK7Ry3xgKAUdSyfT2GXmtP3hpr4l2w0Qv0sXAkVzz9xF0OsUjb3pztdAKz9t9pHiIj3C5p0HQZTAr7oVAzjiDu6gntfoMzTB6mY6PKF2TYOBagu0AZAwgwuWb24zrGPXRPS8U01TlY6UVzFJbB+97i0Nim5jQmyf/r38cCAwEAAQ==" )  ; ----- DKIM key mail for [[DOMAIN]]
```

```vim
mail._domainkey	IN	TXT	( "v=DKIM1; k=rsa; p=MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA5tSGc+j5pLEuWeR4NIhDRPhwHUZll1/N3ajHF1wSttUVp/igdcpZTKTD7ccFmsY0l+72Q+rlnoCGGdhdw0ImRoPVZwBfSxvC3alw/YLLCEwpy+J/tXx2WOPdHM95TVbt0S/wVWpPxmr3mAIPO24R4NEf0yQdvktnB26UTcLBEMtqAEtEDLqrea/XM5HQMngWXAARy379H6mo1Yee3wUqYZPX+g8ljZZMpIlvaE0pjtVIZ0kV8/kXz0fa1XHanc6rTsF7/XxCLYJRAK6fcfO8u/Ro65uWNM3x8+WN1nkf/ojh8VN/0A5oUrlQVWba4OEXxCkbZTU7V+4okyyhAHV2+/c0qRsKRNj2YuPl3DmJ8/me/UBHbIEeji7kcBuVkgv0cakHolMbKWESBuuw1F5MPThQ3qbUcCI9mY4OtTnElk40DVXMenKwQ1EnqJZlHtj6XOo0/na4epqH+rtUOXhan6ewd8XQvJk630Qi1FHzWmO7i4pb8Uo0EDrAQmPvCNsR+AttrIdK7Ry3xgKAUdSyfT2GXmtP3hpr4l2w0Qv0sXAkVzz9xF0OsUjb3pztdAKz9t9pHiIj3C5p0HQZTAr7oVAzjiDu6gntfoMzTB6mY6PKF2TYOBagu0AZAwgwuWb24zrGPXRPS8U01TlY6UVzFJbB+97i0Nim5jQmyf/r38cCAwEAAQ==" )  ; ----- DKIM key mail for [[DOMAIN]]
```

Use one of this format following your registar preferences.

Enable the service

```bash
systemctl enable opendkim.service
```

### SPF record

Add the following line in your DNS records replacing `[[SERVER_IP]]` with your server IPv4 address.

```txt
@        IN      TXT     "v=spf1 a mx ip4:[[SERVER_IP]] ~all"
```

### OpenDMARC

#### Install OpenDMARC (optional)

```bash
sudo apt-get install opendmarc
```

Use the configuration file `config/etc/opendmarc.conf` (backup your `/etc/opendmarc.conf` before) and replace `[[DOMAIN]]` with your domain name.

Create the folders for Postfix and add the `opendmarc` groups to the `postfix` user.

```bash
mkdir /var/spool/postfix/opendmarc
chown opendmarc: /var/spool/postfix/opendmarc
usermod -aG opendmarc postfix
```

Enable the service

```bash
systemctl enable opendmarc.service
```

Restart the services

Enable the service

```bash
systemctl restart opendmarc.service
systemctl restart postfix.service
```

#### Add DMARC record

Just add a DMARC rule in your DNS records.

If you didn't install the opendmarc:

```txt
_dmarc                   IN TXT    "v=DMARC1; p=none"
```

Else add this one (don't forget to replace `[[DOMAIN]]` with your domain name):

```txt
_dmarc  IN  TXT "
    v=DMARC1; 
    p=reject; 
    rua=mailto:postmaster@[[DOMAIN]]; 
    ruf=mailto:admin@[[DOMAIN]]; 
    adkim=s;
    aspf=s; 
    pct=100; 
    rf=afrf; 
    sp=reject
"
```

For more informations on DMARC options, see the following links:

http://dmarc.org/overview  
http://www.kitterman.com/dmarc/assistant.html

### ClamAV

```bash
sudo apt-get install clamav-milter
```

First, update the ClamAV database.

```bash
systemctl stop clamav-freshclam
freshclam

...

systemctl start clamav-freshclam
```

Then start the daemon.

```bash
systemctl start clamav-daemon
```

Create the folders to use it with postfix

```bash
mkdir /var/spool/postfix/clamav
chown clamav /var/spool/postfix/clamav
```

You can use the configuration file `config/etc/clamav/clamav-milter` or use the following command to configure ClamAV.

```bash
dpkg-reconfigure clamav-milter
```

Restart the daemon

```bash
systemctl restart clamav-daemon
```

### Sieve

```bash
sudo apt-get install dovecot-sieve dovecot-managesieved
```

Don't forget to compile your script with sieve

```bash
sievec /var/mail/sieve/default.sieve
```

You can use the custom script `/home/user/.dovecot.sieve`, place it in your user home folder and compile it with `sievec`.

## Restart the services

Restart all the services

```bash
systemctl restart postfix
systemctl restart dovecot
systemctl restart opendkim
systemctl restart opendmarc
```

## Test your configuration

Use [Mail Tester] website to check your configuration.


## Ressources (French)

[Postfix + Dovecot + Rainloop install](https://mondedie.fr/d/5750-tuto-installer-un-serveur-de-mail-avec-postfix-dovecot-et-rainloop/2)  
[Optimize e-mail send on OVH](https://docs.ovh.com/fr/dedicated/optimiser-envoi-emails/)

[Postfix Documentation]: http://www.postfix.org/documentation.html
[Postfix Wikipedia]: https://en.wikipedia.org/wiki/Postfix_(software)
[Dovecot Documentation]: https://doc.dovecot.org/
[Dovecot Wikipedia]: https://en.wikipedia.org/wiki/Dovecot_(software)
[SpamAssassin Documentation]: https://spamassassin.apache.org/doc.html
[SpamAssassin Wikipedia]: https://en.wikipedia.org/wiki/Apache_SpamAssassin
[OpenDKIM Documentation]: http://opendkim.org/docs.html
[DKIM Wikipedia]: https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail
[OpenDMARC Documentation]: http://www.trusteddomain.org/opendmarc/
[DMARC Wikipedia]: https://en.wikipedia.org/wiki/DMARC
[ClamAV Documentation]: https://www.clamav.net/documents/clam-antivirus-user-manual
[ClamAV Wikipedia]: https://en.wikipedia.org/wiki/Clam_AntiVirus
[Sieve Documentation]: http://sieve.info
[Sieve Wikipedia]: https://en.wikipedia.org/wiki/Sieve_(mail_filtering_language)

[Mail Tester]: http://www.mail-tester.com
